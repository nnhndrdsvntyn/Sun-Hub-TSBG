-- Notify (Detect) Saitama Ultimate Activation üü¢üìú

-- Services
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local workspace = game:GetService("Workspace")

local localPlayer = Players.LocalPlayer
local animationId = 12447707844 -- Death Counter animation ID

-- Store the detected players and the time their animation finishes
local detectedPlayers = {}

-- List of moves to check for
local toolNames = {
    "Death Counter",
    "Table Flip",
    "Serious Punch",
    "Omni Directional Punch"
}

-- Function to check if the player is currently performing the animation
local function isPerformingAnimation(player)
    local character = player.Character
    if not character or not character:FindFirstChild("Humanoid") then return nil end
    
    local humanoid = character.Humanoid
    -- Check if the humanoid is currently playing the animation
    for _, anim in pairs(humanoid:GetPlayingAnimationTracks()) do
        -- Check if the animation's AnimationId matches the target animation
        if anim.Animation and tostring(anim.Animation.AnimationId) == "rbxassetid://" .. animationId then
            return anim -- Return the animation track for its length
        end
    end
    return nil
end

-- Function to log the player
local function logDetectedPlayer(player)
    print("üö® " .. player.Name .. " did the animation to Activate Saitama Ultimate ")
end

-- Function to log checking hotbar for tools
local function checkPlayerHotbar(player)
    local backpack = player.Backpack
    local foundTools = 0
    local missedTools = {}

    -- Log checking the hotbar once before starting the checks
    print("‚è≥ Checking " .. player.Name .. "'s Hotbar")

    -- Check each tool in the list
    for _, toolName in pairs(toolNames) do
        -- Check if the tool is in the hotbar
        local tool = backpack:FindFirstChild(toolName)
        if tool then
            foundTools = foundTools + 1
            print("‚öî Found the " .. toolName .. " move in " .. player.Name .. "'s hotbar...")
        else
            table.insert(missedTools, toolName)
            print("üî¥ Couldn't find the " .. toolName .. " move in " .. player.Name .. "'s hotbar...")
        end
    end

    -- Log the final result
    if foundTools == #toolNames then
        print("‚úÖ Found 4/4 Tools In " .. player.Name .. "'s Hotbar")
        return true
    else
        print("‚õî Found " .. foundTools .. "/4 Moves In " .. player.Name .. "'s Hotbar")
        return false
    end
end

-- Function to check the Ulted attribute using the provided method
local function checkUltedAttribute(player)
    -- Retrieve the target object from workspace
    local detectedPlayerPath = workspace:WaitForChild("Live"):WaitForChild(player.Name)
    
    -- Check if the object exists
    if detectedPlayerPath then
        local ultedFound = false  -- Flag to track if the Ulted attribute is found
        -- Iterate through all attributes of the object
        for attributeName, attributeValue in pairs(detectedPlayerPath:GetAttributes()) do
            -- Check if the attribute name is 'Ulted'
            if attributeName == "Ulted" then
                -- Log the state (On/Off)
                print("üü¢" .. player.Name .. " has the Ulted Attribute!")
                ultedFound = true  -- Set the flag to true if Ulted is found
                if attributeValue == true then
                    print("‚úÖ The Ulted Attribute is ON for " .. player.Name)
                    return true
                else
                    print("‚õî The Ulted Attribute is OFF for " .. player.Name)
                    return false
                end
            end
        end
        -- If the Ulted attribute was not found
        if not ultedFound then
            print("üî¥ " .. player.Name .. " does not have the Ulted Attribute!")
            return false
        end
    else
        print("‚ùó " .. player.Name .. " not found in workspace.Live")
        return false
    end
end

-- Function to send a notification in CoreGui
local function sendNotification(player, message, title)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = message,
        Duration = 5
    })
end

-- Heartbeat check to continuously detect animations
local detectingUltimate = false  -- Flag to keep track of detection state

-- Function to start detecting the Saitama Ultimate activation
local function startDetectingUltimate()
    detectingUltimate = true
    -- Heartbeat check to continuously detect animations
    RunService.Heartbeat:Connect(function()
        if detectingUltimate then
            for _, player in pairs(Players:GetPlayers()) do
                -- Exclude the local player
                if player ~= localPlayer then
                    -- Check if this player is performing the animation and hasn't been logged recently
                    local animationTrack = isPerformingAnimation(player)
                    if animationTrack and not detectedPlayers[player] then
                        -- Log the player and mark as detected
                        logDetectedPlayer(player)
                        detectedPlayers[player] = true
                        
                        -- Wait 1.5 seconds after detecting animation before checking the hotbar
                        wait(1.5)

                        -- Log the check for ultimate
                        print("üîÑ Checking If " .. player.Name .. " actually activated Ultimate...")

                        -- Check the player's hotbar for the tools
                        local movesCheck = checkPlayerHotbar(player)

                        -- Wait 0.25 seconds after tools check before checking the attributes
                        wait(0.25)

                        -- Log the proceeding to check attributes
                        print("‚è≥ Proceeding to check " .. player.Name .. "'s Attributes")

                        -- Check the Ulted attribute
                        local attributeCheck = checkUltedAttribute(player)

                        -- Calculate the success rate
                        local animationCheck = animationTrack and true or false
                        local animationResult = animationCheck and "‚úÖ" or "‚õî"
                        local movesResult = movesCheck and "‚úÖ" or "‚õî"
                        local attributeResult = attributeCheck and "‚úÖ" or "‚õî"

                        -- Calculate the total percentage chance
                        local chance = 0
                        if animationCheck then chance = chance + 2 end
                        if movesCheck then chance = chance + 18 end
                        if attributeCheck then chance = chance + 80 end

                        -- Log the conclusion
                        print("Conclusion: ")
                        print("Animation Check: " .. animationResult)
                        if animationCheck then print("Might have activated Ultimate ü§∑‚Äç‚ôÇÔ∏è +2%") end
                        print("Moves Check: " .. movesResult)
                        if movesCheck then print("Probably activated Ultimate üëç +18%") end
                        print("Attribute Check: " .. attributeResult)
                        if attributeCheck then print("Definitely activated Ultimate ‚úÖ +80%") end
                        print(string.format("%d/3 Checks Succeeded", (animationCheck and 1 or 0) + (movesCheck and 1 or 0) + (attributeCheck and 1 or 0)))

                        -- Final Conclusion based on the chance
                        if chance < 3 then
                            print("üî¥ " .. player.Name .. " Most likely did not activate Saitama Ultimate.")
                            sendNotification(player, "üî¥ " .. player.Name .. " Most likely did not activate Saitama Ultimate.", "Conclusion")
                        elseif chance >= 18 and chance < 20 then
                            print("üü° " .. player.Name .. " Might have activated Saitama Ultimate...")
                            sendNotification(player, "üü° " .. player.Name .. " Might have activated Saitama Ultimate...", "Conclusion")
                        elseif chance == 100 then
                            print("üü¢ " .. player.Name .. " Definitely activated Saitama Ultimate!")
                            sendNotification(player, "üü¢ " .. player.Name .. " Definitely activated Saitama Ultimate!", "Conclusion")
                        end

                        -- Wait until the animation finishes, plus an extra 0.25 seconds buffer
                        wait(animationTrack.Length + 0.25)

                        -- Remove the player from the detected list after the wait
                        detectedPlayers[player] = nil
                    end
                end
            end
        end
    end)
end

-- Function to stop detecting the Saitama Ultimate activation
local function stopDetectingUltimate()
    detectingUltimate = false
end

-- Function to send the Death Counter notification
local function sendDeathCounterNotification(player)
    StarterGui:SetCore("SendNotification", {
        Title = "üü¢ " .. player.Name .. " Activated Death Counter",
        Text = "When this notification disappears, then their Death Counter is gone",
        Duration = 10.5  -- Notification duration set to 10.5 seconds
    })
end

-- Detect Death Counter Animation Functionality üü¢üìú

-- Function to check for the "HoldingDeathCounter" attribute
local function checkHoldingDeathCounter(player)
    -- Retrieve the target object from workspace
    local detectedPlayerPath = workspace:WaitForChild("Live"):WaitForChild(player.Name)
    
    -- Check if the object exists
    if detectedPlayerPath then
        -- Iterate through all attributes of the object
        for attributeName, attributeValue in pairs(detectedPlayerPath:GetAttributes()) do
            -- Check if the attribute name is 'HoldingDeathCounter' and if it is true
            if attributeName == "HoldingDeathCounter" and attributeValue == true then
                -- Log the state
                print("üü¢ " .. player.Name .. " activated Death Counter")
                -- Send the notification
                sendDeathCounterNotification(player)
            end
        end
    else
        print("‚ùó " .. player.Name .. " not found in workspace.Live")
    end
end

-- Heartbeat check to continuously detect the "HoldingDeathCounter" attribute
local detectingDeathCounter = false

-- Function to start detecting the Death Counter activation
local function startDetectingDeathCounter()
    detectingDeathCounter = true
    -- Heartbeat check to continuously detect the attribute
    RunService.Heartbeat:Connect(function()
        if detectingDeathCounter then
            for _, player in pairs(Players:GetPlayers()) do
                -- Exclude the local player
                if player ~= localPlayer then
                    -- Check if this player has the "HoldingDeathCounter" attribute
                    checkHoldingDeathCounter(player)
                end
            end
        end
    end)
end

-- Function to stop detecting the Death Counter activation
local function stopDetectingDeathCounter()
    detectingDeathCounter = false
end

-- Anti Death Counter Functionality üü¢

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Variables
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local antiDeathCounterEnabled = false -- Toggle state variable
local animationId = "rbxassetid://11343250001" -- Animation ID

-- Function to update character and humanoid references on respawn
local function updateCharacterReferences()
    Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    Humanoid = Character:WaitForChild("Humanoid")
end

-- Function to generate random position
local function getRandomPosition(currentPosition)
    local randomX = math.random(20000, 50000) * (math.random(0, 1) == 0 and -1 or 1)
    local randomZ = math.random(20000, 50000) * (math.random(0, 1) == 0 and -1 or 1)
    return Vector3.new(currentPosition.X + randomX, -499, currentPosition.Z + randomZ)
end

-- Main functionality
local function handleDeathCounter()
    print("üö® Your player seems to have gotten Death Countered")

    -- Save current camera state and position
    local originalCFrame = Camera.CFrame
    local originalFocus = Camera.Focus
    local playerPosition = Character.PrimaryPart.Position

    -- Change camera to custom state
    Camera.CameraType = Enum.CameraType.Scriptable
    Camera.CFrame = originalCFrame

    -- Create platform at a distant random location
    local platformPosition = getRandomPosition(playerPosition)
    local platform = Instance.new("Part")
    platform.Size = Vector3.new(1500, 1, 1500)
    platform.Position = platformPosition
    platform.Anchored = true
    platform.Transparency = 1
    platform.Material = Enum.Material.Neon
    platform.BrickColor = BrickColor.Red()
    platform.Parent = workspace

    -- Teleport player to platform
    Character:SetPrimaryPartCFrame(CFrame.new(platformPosition + Vector3.new(0, 1, 0)))

    -- Wait 13 seconds before reverting
    task.delay(13, function()
        -- Teleport player back
        Character:SetPrimaryPartCFrame(CFrame.new(playerPosition))

        -- Remove platform
        platform:Destroy()

        -- Restore camera state
        Camera.CameraType = Enum.CameraType.Custom
        Camera.CFrame = originalCFrame
        Camera.Focus = originalFocus
    end)
end

-- Function to detect animation
local function detectDeathCounter()
    Humanoid.AnimationPlayed:Connect(function(animationTrack)
        -- Check toggle state and animation ID
        if antiDeathCounterEnabled and animationTrack.Animation.AnimationId == animationId then
            handleDeathCounter()
        end
    end)
end

-- Listen for character respawns to reapply detection logic
LocalPlayer.CharacterAdded:Connect(function()
    updateCharacterReferences()
    detectDeathCounter()
end)

-- Initial setup
detectDeathCounter()

-- Services
local StarterGui = game:GetService("StarterGui")

-- Helper function for notifications
local function sendNotification(title, text, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 5 -- Default duration is 5 seconds
    })
end

-- Now load the UI
local SunHubTSBGArena = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local Window = SunHubTSBGArena:CreateWindow({
    Title = "TSBG - Arena",
    SubTitle = "by Lib",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, -- The blur may be detectable, setting this to false disables blur entirely
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl -- Used when theres no MinimizeKeybind
})

-- Fluent provides Lucide Icons, they are optional
local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local DetectSection = Tabs.Main:AddSection("Detect")

-- Create the toggles for Ultimate and Death Counter detection
local DetectSaitamaUltimateToggle = DetectSection:AddToggle("Detect Saitama Ultimate", 
{
    Title = "Detect Saitama Ultimate Activation", 
    Description = "Will detect and notify you when another player activates Saitama Ultimate.",
    Default = false,
    Callback = function(state)
        if state then
            -- Enable detection when toggle is turned on
            sendNotification("Saitama Ultimate Detection", "ON - Notifying Saitama Ultimate Activation. üü¢", 5)
            startDetectingUltimate()  -- Start detecting logic
        else
            -- Disable detection when toggle is turned off
            sendNotification("Saitama Ultimate Detection", "OFF - Not Notifying Saitama Ultimate Activation. üî¥", 5)
            stopDetectingUltimate()  -- Stop detecting logic
        end
    end 
})

local DetectSaitamaDeathCounterToggle = DetectSection:AddToggle("Detect Saitama Death Counter", 
{
    Title = "Detect Death Counter Activation", 
    Description = "Will detect and notify you when another player activates Saitama Death Counter.",
    Default = false,
    Callback = function(state)
        if state then
            sendNotification("Death Counter Detection", "ON - Notifying Death Counter Activation. üü¢", 5)
            startDetectingDeathCounter()  -- Start the Death Counter detection
        else
            sendNotification("Death Counter Detection", "OFF - Not Notifying Death Counter Activation. üî¥", 5)
            stopDetectingDeathCounter()  -- Stop the Death Counter detection
        end
    end 
})

local AntiSection = Tabs.Main:AddSection("Anti")

-- New toggle for Anti-Death Counter
local AntiDeathCounterToggle = AntiSection:AddToggle("AntiDeathCounterToggle", 
{
    Title = "Anti Death Counter", 
    Description = "Will kill the person who death countered you, and will save you from dying to the death counter.",
    Default = false,
    Callback = function(state)
        antiDeathCounterEnabled = state
        if state then
            sendNotification("Anti Death Counter", "ON - Anti Death Counter is on. üü¢", 5)
        else
            sendNotification("Anti Death Counter", "OFF - Anti Death Counter is off. üî¥", 5)
        end
    end
})
